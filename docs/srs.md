# Спецификация проектов Scanf и Printf

## Версия 0.0.1

## 1. Глоссарий

| Термин             | Определение                                                                                                                                                                                                                                                   |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FreeRTOS           | Операционная система реального времени с поддержкой многозадачности.                                                                                                                                                                                          |
| Трассировка        | Процесс сбора информации о событиях, происходящих в системе во время выполнения программы.                                                                                                                                                                    |
| Трассировочный хук | Функция обратного вызова, активируемая ядром при наступлении события. Подробнее с механизмом трассировки FreeRTOS можно ознакомиться в [официальной документации](https://www.freertos.org/Documentation/02-Kernel/02-Kernel-features/09-RTOS-trace-feature). |
| Scanf              | Библиотека для сбора трассировочных данных в FreeRTOS.                                                                                                                                                                                                        |
| Printf             | Инструмент для анализа и визуализации трассировочных данных, собранных с помощью **Scanf**.                                                                                                                                                                   |
| Трейс-лог          | Журнал, содержащий последовательность трассировочных событий системы.                                                                                                                                                                                         |
| Jupyter Notebook   | Интерактивная среда для анализа и визуализации данных с использованием Python.                                                                                                                                                                                |

## 2. Обзор

FreeRTOS предоставляет механизмы многозадачности в реальном времени, что дает множество преимуществ, но также добавляет сложность при разработке. Одним из ключевых аспектов является анализ взаимодействий задач во время выполнения.

Визуальная трассировка позволяет:

- Наглядно оценить работу программы.
- Выявлять проблемы на высоком уровне.
- Анализировать последовательность событий в деталях.

Проекты **Scanf** и **Printf** обеспечивают сбор, обработку и визуализацию трассировочных данных, упрощая процесс отладки многозадачных приложений на FreeRTOS.

## 3. Scanf

Ядро FreeRTOS содержит более 100 трассировочных хуков для регистрации значимых событий во время работы системы. **Scanf** — это header-only библиотека, определяющая эти хуки и сохраняющая информацию о событиях трассировки.

### 3.1 Функциональные требования

- Возможность включать и выключать трассировку.
- Сохранение записей трассировки в память с возможностью определения способа их хранения и передачи.
- Фиксация событий:
  - Выбор задачи для исполнения (**traceTASK\_SWITCHED\_IN**).
  - Снятие задачи с исполнения (**traceTASK\_SWITCHED\_OUT**).
- Включение в трассировку следующей информации:
  - Время начала события.
  - Идентификатор задачи.
  - Тип события.

### 3.2 Нефункциональные требования

- Явная аллокация памяти.
- Подключение **Scanf** не должно требовать модификации ядра FreeRTOS.
- Простая интеграция: достаточно включения `scanf.h` в файл конфигурации FreeRTOS.
- Потокобезопасность.
- Минимальное влияние на производительность системы.

### 3.3 API

```c
typedef struct {
    uint64_t timestamp;
    uint64_t task_id;
    uint16_t event_type;
} SCANF_TraceMessage;

typedef struct {
    size_t count;
    size_t capacity;
    SCANF_TraceMessage* messages;
} SCANF_TraceLog;

/// Инициализация глобального журнала трассировки с заданной ёмкостью.
/// Выделяет в куче log_capacity * sizeof(SCANF_TraceMessage) байт.
void SCANF_INIT(size_t log_capacity);

/// Сброс журнала трассировки.
void SCANF_RESET();

/// Включение трассировки.
void SCANF_ENABLE_TRACING();

/// Отключение трассировки.
void SCANF_DISABLE_TRACING();

/// Сохранение журнала трассировки с использованием переданного обработчика.
void SCANF_SAVE(void (*save_handler)(SCANF_TraceLog*));
```

### 3.4 Желаемый функционал будущих версий

- Поддержка дополнительных событий задач.
- Трассировка событий других сущностей (очередей, таймеров и т. д.).
- Реализация базовых методов сохранения журнала трассировки (TCP, UART, FAT).

## 4. Printf

**Printf** — это инструмент анализа и визуализации трассировочных данных, собранных при помощи **Scanf**.
Текущая реализация представляет собой Jupyter Notebook для обработки и визуального отображения данных.

### 4.1 Функциональные требования

- Работа с файлами, содержащими бинарный журнал трассировки в формате **Scanf**.
- Визуальное отображение исполнения задач на временной диаграмме, где должны присутствовать:
  - Все зарегистрированные задачи.
  - Состояние задач в определённый временной период.

### 4.2 Нефункциональные требования

- Кроссплатформенность (MacOS, Windows, Linux).

### 4.3 Желаемый функционал будущих версий

- Поддержка различных типов событий.
- Группировка событий по видам сущностей (задачи, очереди и т. д.).
- Перенос на полноценное десктопное или веб-приложение.
- Интеграция со средствами отладки для удобной выгрузки журнала трассировки.
